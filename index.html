<!DOCTYPE html>
<html>
<head>
  <title>National Library GIS Dashboard</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { margin:0; font-family: Arial; display:flex; background:#f5f7fa; }

    #sidebar {
      width:300px;
      padding:15px;
      background:#fff;
      box-shadow:2px 0 10px rgba(0,0,0,0.05);
    }

    #map { flex:1; height:100vh; }

    input, select {
      width:100%;
      margin-bottom:10px;
      padding:6px;
    }

    #breadcrumb, #legend, #timelineBox, #topbar {
      position:absolute;
      background:white;
      padding:10px;
      border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
      z-index:1000;
    }

    #breadcrumb { top:10px; left:320px; }
    #timelineBox { bottom:20px; left:320px; }
    #legend { bottom:20px; right:20px; }

    #topbar {
      top:10px;
      left:500px;
      display:flex;
      gap:10px;
    }

    .card {
      padding:10px;
      background:#fff;
      border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
      font-size:14px;
    }

    #loader {
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:white;
      padding:20px;
      display:none;
      z-index:2000;
    }

    @media(max-width:768px){
      body { flex-direction:column; }
      #sidebar { width:100%; }
    }
  </style>
</head>

<body>

<div id="sidebar">
  <h2>Dashboard</h2>

  <input type="text" id="searchBox" placeholder="Search library...">

  <select id="stateFilter"><option value="all">All States</option></select>
  <select id="districtFilter"><option value="all">All Districts</option></select>

  <p>Total: <span id="count">0</span></p>

  <button onclick="loadIndia()">⬅ Back</button>
</div>

<div id="breadcrumb">India</div>

<div id="topbar">
  <div class="card">Total<br><b id="totalLib">0</b></div>
  <div class="card">States<br><b id="totalStates">0</b></div>
  <div class="card">Year<br><b id="yearKPI">2025</b></div>
</div>

<div id="map"></div>

<div id="timelineBox">
  <input type="range" id="yearRange" min="1800" max="2025" value="2025">
  <p>Year: <span id="yearValue">2025</span></p>
</div>

<div id="legend"></div>
<div id="loader">Loading...</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
var map = L.map('map').setView([22.5,80],5);
L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png').addTo(map);

var cluster = L.markerClusterGroup();
map.addLayer(cluster);

var data=[];

// LOAD DATA
fetch('libraries_full.json')
.then(res=>res.json())
.then(d=>{
  data=d;
  populateFilters();
  updateMap();
});

// FILTERS
function populateFilters(){
  let states=[...new Set(data.map(d=>d.state))];
  let districts=[...new Set(data.map(d=>d.district))];

  states.forEach(s=>{
    stateFilter.innerHTML+=`<option>${s}</option>`;
  });

  districts.forEach(d=>{
    districtFilter.innerHTML+=`<option>${d}</option>`;
  });
}

// MARKERS
function showMarkers(filtered){
  cluster.clearLayers();

  let year=yearRange.value;

  let final=filtered.filter(d=>d.year<=year);

  final.forEach(lib=>{
    let marker=L.marker([lib.lat,lib.lon])
    .bindPopup(`
      <b>${lib.name}</b><br>
      ${lib.district}<br>
      Year: ${lib.year}
    `);
    cluster.addLayer(marker);
  });

  count.innerText=final.length;

  // KPI
  totalLib.innerText=final.length;
  totalStates.innerText=[...new Set(final.map(d=>d.state))].length;
  yearKPI.innerText=year;
}

// MAIN UPDATE
function updateMap(){

  let state=stateFilter.value;
  let district=districtFilter.value;

  let filtered=data.filter(d=>{
    return (state==="all"||d.state===state) &&
           (district==="all"||d.district===district);
  });

  showMarkers(filtered);
}

// SEARCH
searchBox.addEventListener("input",function(){
  let val=this.value.toLowerCase();
  let filtered=data.filter(d=>d.name.toLowerCase().includes(val));
  showMarkers(filtered);
});

// EVENTS
stateFilter.onchange=updateMap;
districtFilter.onchange=updateMap;

yearRange.oninput=function(){
  yearValue.innerText=this.value;
  updateMap();
};

// LEGEND
legend.innerHTML = `
<b>Library Density</b><br>
<div style="height:10px;background:linear-gradient(to right,#c6dbef,#084594)"></div>
Low → High
`;

// INIT
function loadIndia(){
  map.setView([22.5,80],5);
  breadcrumb.innerText="India";
}

loadIndia();
</script>

</body>
</html>
